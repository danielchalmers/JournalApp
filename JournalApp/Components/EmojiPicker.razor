@namespace JournalApp
@inject IJSRuntime JSRuntime

<EmojiButton OnClick="@(() => _isOpen = !_isOpen)"
             AriaLabel="Choose emoji for day's mood">
    @(SelectedMood ?? DataPoint.Moods[0])
</EmojiButton>

<MudPopover Open="@_isOpen"
            AnchorOrigin="Origin.TopLeft"
            TransformOrigin="Origin.TopLeft"
            Class="emoji-popover">
    <div class="emoji-popover-content">
        @foreach (var mood in DataPoint.Moods)
        {
            <EmojiButton OnClick="@((args) => OnMoodClicked(mood, args))"
                         AriaLabel="@($"Select {mood} mood")">
                @mood
            </EmojiButton>
        }
    </div>
</MudPopover>

<MudOverlay @bind-Visible="@_isOpen"
            AutoClose
            LockScroll="false" />

@code {
    private bool _isOpen;

    [Parameter]
    public string SelectedMood { get; set; }

    [Parameter]
    public EventCallback<string> OnMoodSelected { get; set; }

    private async Task OnMoodClicked(string mood, MouseEventArgs args)
    {
        // Trigger the visual effect first while the popover is still open
        await TriggerMoodEffect(mood, args);
        
        _isOpen = false;
        
        await OnMoodSelected.InvokeAsync(mood);
    }

    private async Task TriggerMoodEffect(string mood, MouseEventArgs args)
    {
        try
        {
            // Use the event target coordinates for the effect origin
            await JSRuntime.InvokeVoidAsync("moodEffects.showEffect", mood, new { 
                clientX = args.ClientX, 
                clientY = args.ClientY 
            });
        }
        catch (Exception)
        {
            // Silently fail if JavaScript is not available
        }
    }
}
