@namespace JournalApp
@inject AppDbContext db
@inject ILogger<TrendsDialog> logger
@inject IDialogService DialogService
@inject PageService PageService

<MudDialog DefaultFocus="DefaultFocus.None">
	<TitleContent>
		<div class="page-header">
			<MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="Submit" />

			<MudText Typo="Typo.h6">Trends</MudText>
		</div>

		<TrendsSwitcher @bind-SelectedDate="SelectedDate" />
	</TitleContent>

	<DialogContent>
		<div class="trends-category-list">
			@foreach (var (category, categoryPoints) in _allPoints)
			{
				@if (TrendView.IsSupported(category.Type))
				{
					<div class="trends-category">
						<MudText Typo="Typo.h6">
							@category.Name
						</MudText>

						<TrendView Category="category" Points="categoryPoints" />
					</div>
				}
			}
		</div>
	</DialogContent>
</MudDialog>

@code {
	Dictionary<DataPointCategory, IReadOnlyDictionary<int, DataPoint>> _allPoints;
	DateOnly _selectedDate;

	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	[Parameter]
	public DateOnly OpenToDate { get; set; }

	public DateOnly SelectedDate
	{
		get => _selectedDate;
		set
		{
			_selectedDate = value;

			// Group data points by category and its points of the selected month.
			_allPoints = new();
			foreach (var category in db.Categories.Where(x => x.Enabled && !x.Deleted).OrderBy(x => x.Type))
			{
				var dayPoints = new Dictionary<int, DataPoint>();

				// Each day has either a matching data point or null.
				for (int day = 0; day < DateTime.DaysInMonth(value.Year, value.Month); day++)
				{
					var point = category.Points.FirstOrDefault(p => p.Day.Date.Year == value.Year && p.Day.Date.Month == value.Month && p.Day.Date.Day == day);
					dayPoints.Add(day, point);
				}

				_allPoints.Add(category, dayPoints);
			}
		}
	}

	protected override void OnInitialized()
	{
		base.OnInitialized();

		PageService.EnteredPage(() => Submit());

		logger.LogInformation($"Opened to {OpenToDate}");
		SelectedDate = new(OpenToDate.Year, OpenToDate.Month, 1);
	}

	void Submit()
	{
		PageService.CloseDialog(MudDialog, true);
	}
}