@namespace JournalApp
@inject IDialogService DialogService
@inject IScrollManager ScrollManager
@inject IJSRuntime JSRuntime
@inject PageService PageService

<MudDialog DefaultFocus="DefaultFocus.None">
	<TitleContent>
		<div class="page-header">
			<MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Title="Close" OnClick="Close" />

			<MudText Typo="Typo.h6">Worksheets</MudText>
		</div>
	</TitleContent>

	<DialogContent>
		<div class="worksheet-group-list">
			<div class="worksheet-group">
				<MudText Typo="Typo.h4">Table of Contents</MudText>

				<div class="worksheet-group-toc">
					@foreach (var group in WorksheetGroups)
					{
						@if (!string.IsNullOrEmpty(group.Key))
						{
							<div class="worksheet-group-toc-item">
								<MudLink OnClick="async () => await ScrollToGroup(MarkupUtil.ToClassName(group.Key))">• @group.Key</MudLink>
							</div>
						}
					}
				</div>
			</div>

			@foreach (var group in WorksheetGroups)
			{
				<div class="worksheet-group" id="worksheet-group-key-@(MarkupUtil.ToClassName(group.Key))">
					@if (!string.IsNullOrEmpty(group.Key))
					{
						<div class="d-flex align-center">
							<MudText Typo="Typo.h4">@group.Key</MudText>
							<MudIconButton Icon="@Icons.Material.Filled.ArrowUpward" OnClick="ScrollToTop" title="Scroll to top" />
						</div>
					}

					<div class="worksheet-group-items">
						@foreach (var ws in group)
						{
							<WorksheetView Worksheet="ws" />
						}
					</div>
				</div>
			}
		</div>
	</DialogContent>
</MudDialog>

@code {
	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	public IEnumerable<IGrouping<string, Worksheet>> WorksheetGroups => WorksheetData.AllWorksheets.GroupBy(x => x.Category);

	protected override void OnInitialized()
	{
		base.OnInitialized();

		PageService.EnteredPage(() => Close());
	}

	void Close()
	{
		PageService.CloseDialog(MudDialog, true);
	}

	async Task ScrollToTop()
	{
		await ScrollManager.ScrollToTopAsync(".mud-dialog", ScrollBehavior.Smooth);
	}

	async Task ScrollToGroup(string key)
	{
		await JSRuntime.InvokeVoidAsyncIgnoreErrors("scrollToElementInsideDialog", $"#worksheet-group-key-{key}");
	}
}