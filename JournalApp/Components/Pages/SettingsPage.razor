@namespace JournalApp
@page "/settings"
@implements IDisposable
@inject ILogger<SettingsPage> logger
@inject KeyEventService KeyEventService
@inject NavigationManager NavigationManager
@inject AppDataService AppDataService
@inject IDialogService DialogService

@if (_isBusy)
{
	@* TODO: Replace with separate page so we can change state of inline fields and have it updated properly in settings *@
	<div class="d-flex justify-center">
		<MudProgressCircular Color="Color.Primary" Style="height:33vw;width:33vw;margin-top:10vh;" Indeterminate="true" />
	</div>
}
else
{
	<div class="page-title">
		<div class="page-header">
			<MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Title="Back" OnClick="Close" />

			<MudText Typo="Typo.h6">Settings</MudText>
		</div>
	</div>

	<div class="page-body">
		<div class="settings-group-list">
			<div class="settings-group">
				<MudText Typo="Typo.h4">Personalization</MudText>

				<MudButton StartIcon="@Icons.Material.Filled.HealthAndSafety" OnClick="SetUpSafetyPlan" Variant="Variant.Outlined" FullWidth>Set Up Safety Plan</MudButton>
			</div>

			<div class="settings-group">
				<MudText Typo="Typo.h4">Data & backups</MudText>

				<MudButton StartIcon="@Icons.Material.Filled.Upload" OnClick="StartExport" Variant="Variant.Outlined" FullWidth>Export</MudButton>

				<MudButton StartIcon="@Icons.Material.Filled.Download" OnClick="PickAndStartImport" Variant="Variant.Outlined" FullWidth>Import</MudButton>
			</div>

			<div class="settings-group">
				<MudText Typo="Typo.h4">About</MudText>

				<MudText>JournalApp @(ThisAssembly.AssemblyInformationalVersion)</MudText>
				<MudText>@($"{DeviceInfo.Current.Platform} {DeviceInfo.Current.VersionString}")</MudText>

				<MudLink Href="@(Feedback.GenerateLink())">Send feedback...</MudLink>
			</div>

			<div class="settings-group">
				<MudText Typo="Typo.h4">Credits</MudText>

				<MudTextField T="string" Text="@CreditsText" AutoGrow ReadOnly DisableUnderLine />
			</div>
		</div>
	</div>
}

@code {
	bool _isBusy;

	public string CreditsText { get; private set; }

	protected override async Task OnInitializedAsync()
	{
		CreditsText = await GetCreditsText();

		await base.OnInitializedAsync();

		KeyEventService.Entered(Close);
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		await base.OnAfterRenderAsync(firstRender);

		if (firstRender)
		{
			if (App.ActivatedFilePath != null)
			{
				await StartImport();
				StateHasChanged();
			}
		}
	}

	void SetUpSafetyPlan()
	{
		logger.LogInformation("Setting up Safety Plan");
		NavigationManager.NavigateTo($"/safetyplan", false, true);
	}

	async Task PickAndStartImport()
	{
		if (DeviceInfo.Current.Platform == DevicePlatform.WinUI)
		{
			logger.LogInformation("Picking import file");

			var pickResult = await FilePicker.Default.PickAsync();

			if (pickResult == null)
				return;

			App.ActivatedFilePath = pickResult.FullPath;

			await StartImport();
		}
		else
		{
			logger.LogInformation("Explaining how to import");
			await DialogService.ShowCustomMessageBox(string.Empty, "Find the backup in your files app and click it or choose Open With -> JournalApp. You can also share the file directly from another app.", showFeedbackLink: true);
		}
	}

	async Task StartImport()
	{
		try
		{
			_isBusy = true;
			StateHasChanged();

			var path = App.ActivatedFilePath;

			await AppDataService.StartImportWizard(DialogService, App.ActivatedFilePath);
		}
		finally
		{
			App.ActivatedFilePath = null;
			_isBusy = false;
		}
	}

	async Task StartExport()
	{
		try
		{
			_isBusy = true;
			StateHasChanged();

			await AppDataService.StartExportWizard(DialogService);
		}
		finally
		{
			_isBusy = false;
		}
	}

	public async Task<string> GetCreditsText()
	{
		logger.LogDebug("Reading credits file");

		using var stream = await FileSystem.OpenAppPackageFileAsync("Credits.txt");
		using var reader = new StreamReader(stream);
		return reader.ReadToEnd();
	}

	void Close()
	{
		NavigationManager.NavigateTo("/", false, true);
	}

	public void Dispose()
	{
		KeyEventService.Exited();
	}
}