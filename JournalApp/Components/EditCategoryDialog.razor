@namespace JournalApp
@inject IDialogService DialogService
@inject KeycodeService KeycodeService

<MudDialog DefaultFocus="DefaultFocus.FirstChild" OnBackdropClick="SubmitOrCancel">
	<TitleContent>
		<div class="page-header">
			<MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="Cancel" />

			<MudText Typo="Typo.h6">@(Category == null ? "New" : "Edit") @(Group == "Medications" ? "medication" : "category")</MudText>

			<MudSpacer />

			<MudIconButton Icon="@Icons.Material.Filled.Check" OnClick="Submit" />
		</div>
	</TitleContent>

	<DialogContent>
		<MudForm @ref="_form" ValidationDelay="0">
			<MudTextField Label="Name" @bind-Value="Name" Immediate />

				@if (Group == null)
			{
				<MudSelect Label="Type of data" @bind-Value="SelectedType">
					<MudSelectItem Value="DataType.LowToHigh">Low to high</MudSelectItem>
					<MudSelectItem Value="DataType.MildToSevere">Mild to severe</MudSelectItem>
					<MudSelectItem Value="DataType.Scale">1-5 scale</MudSelectItem>
					<MudSelectItem Value="DataType.Bool">Yes or no</MudSelectItem>
					<MudSelectItem Value="DataType.Number">Number</MudSelectItem>
					<MudSelectItem Value="DataType.Text">Text</MudSelectItem>
				</MudSelect>
			}
			else if (Group == "Medications")
			{
				<div class="d-flex flex-row flex-grow-1" style="gap: 1em">
					<MudNumericField @bind-Value="MedicationDose" HideSpinButtons Label="Dose" MaxLength="5" Required Immediate />

						<MudTextField @bind-Value="MedicationUnit" Label="Unit" MaxLength="8" Required Immediate />
					</div>

				<MudSwitch @bind-Checked="MedicationEveryDay" Label="Taken every day" Color="Color.Primary" />
			}
		</MudForm>
	</DialogContent>
</MudDialog>

@code {
	MudForm _form;

	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	[Parameter]
	public string Group { get; set; }

	[Parameter]
	public DataPointCategory Category { get; set; }

	public string Name { get; set; } = string.Empty;

	public DataType SelectedType { get; set; } = DataType.LowToHigh;

	public decimal? MedicationDose { get; set; }

	public string MedicationUnit { get; set; } = "mg";

	public bool MedicationEveryDay { get; set; } = true;

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();

		if (Category != null)
		{
			Group = Category.Group;
			Name = Category.Name;
			SelectedType = Category.Type;
			MedicationDose = Category.MedicationDose;
			MedicationUnit = Category.MedicationUnit;
			MedicationEveryDay = Category.MedicationEveryDaySince != null;
		}

		KeycodeService.SubscribeOnceToBackButtonPressed(() => Cancel());
	}

	void Cancel()
	{
		MudDialog.Close(DialogResult.Cancel());
	}

	async Task<bool> Submit()
	{
		await _form.Validate();
		if (!_form.IsValid)
			return false;

		Category ??= new();
		Category.Group = Group;
		Category.Name = Name.Trim();
		Category.Type = Group == "Medications" ? DataType.Medication : SelectedType;
		Category.MedicationDose = MedicationDose;
		Category.MedicationUnit = MedicationUnit.Trim();
		Category.MedicationEveryDaySince = MedicationEveryDay ? DateTimeOffset.Now : null;

		MudDialog.Close(DialogResult.Ok(Category));
		return true;
	}

	async Task SubmitOrCancel()
	{
		if (!await Submit())
			Cancel();
	}
}