@namespace JournalApp
@using Microsoft.AspNetCore.Components
@using System
@using System.Collections.Generic
@using System.Globalization
@using System.Linq
@using System.Text
@typeparam TValue

<MudToggleGroup T="TValue"
                Id="@_groupId"
                Class="@CssClass"
                Size="@Size"
                SelectionMode="@SelectionMode"
                Disabled="@Disabled"
                Value="@Value"
                ValueChanged="@ValueChanged"
                @attributes="AdditionalAttributesWithoutClass">
    @ChildContent
</MudToggleGroup>

<style>@((MarkupString)_dynamicCss)</style>

@code {
    private const byte PrimaryRed = 234;
    private const byte PrimaryGreen = 184;
    private const byte PrimaryBlue = 214;
    private static readonly double[] HueOffsets = { 0, 35, -35, 70, -70, 140, -140, 175 };
    private readonly string _groupId = $"ja-toggle-group-{Guid.NewGuid():N}";
    private string _dynamicCss = string.Empty;

    [Parameter]
    public TValue Value { get; set; } = default!;

    [Parameter]
    public EventCallback<TValue> ValueChanged { get; set; }

    [Parameter]
    public RenderFragment ChildContent { get; set; } = default!;

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public SelectionMode SelectionMode { get; set; } = SelectionMode.ToggleSelection;

    [Parameter]
    public Size Size { get; set; } = Size.Small;

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private string CssClass
    {
        get
        {
            var builder = new StringBuilder("ja-toggle-group");

            if (!string.IsNullOrWhiteSpace(Class))
            {
                builder.Append(' ').Append(Class);
            }

            if (AdditionalAttributes != null && AdditionalAttributes.TryGetValue("class", out var extraClass))
            {
                var classValue = Convert.ToString(extraClass, CultureInfo.InvariantCulture);
                if (!string.IsNullOrWhiteSpace(classValue))
                {
                    builder.Append(' ').Append(classValue);
                }
            }

            return builder.ToString();
        }
    }

    private IReadOnlyDictionary<string, object>? AdditionalAttributesWithoutClass
    {
        get
        {
            if (AdditionalAttributes == null || !AdditionalAttributes.ContainsKey("class"))
            {
                return AdditionalAttributes;
            }

            return AdditionalAttributes
                .Where(kvp => !string.Equals(kvp.Key, "class", StringComparison.OrdinalIgnoreCase))
                .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        }
    }

    protected override void OnParametersSet()
    {
        _dynamicCss = BuildCss();
    }

    private string BuildCss()
    {
        var colors = BuildPalette();
        var builder = new StringBuilder();

        AppendIndicatorRule(builder, $"#{_groupId}::before", colors[0]);

        for (var i = 0; i < HueOffsets.Length; i++)
        {
            var color = colors[Math.Min(i, colors.Count - 1)];
            var index = i + 1;
            var nthSelector = $"#{_groupId} .mud-toggle-item:nth-child({index})";
            AppendSelectionRule(builder, nthSelector, color);
            AppendIndicatorRule(builder, $"#{_groupId}:has(> .mud-toggle-item:nth-child({index}).mud-toggle-item-selected)::before", color);
        }

        var fallback = colors[^1];
        var fallbackNth = HueOffsets.Length + 1;
        AppendSelectionRule(builder, $"#{_groupId} .mud-toggle-item:nth-child(n+{fallbackNth})", fallback);
        AppendIndicatorRule(builder, $"#{_groupId}:has(> .mud-toggle-item:nth-child(n+{fallbackNth}).mud-toggle-item-selected)::before", fallback);

        return builder.ToString();
    }

    private List<(string Background, string Text)> BuildPalette()
    {
        var (h, s, l) = RgbToHsl(PrimaryRed, PrimaryGreen, PrimaryBlue);
        var colors = new List<(string, string)>(HueOffsets.Length);

        foreach (var offset in HueOffsets)
        {
            var (r, g, b) = FromHsl(ShiftHue(h, offset), s, l);
            var textColor = GetReadableText(r, g, b);
            colors.Add(($"rgba({r},{g},{b},1)", textColor));
        }

        return colors;
    }

    private static void AppendSelectionRule(StringBuilder builder, string selector, (string Background, string Text) color)
    {
        builder.Append(selector)
               .Append(".mud-toggle-item-selected{background-color:")
               .Append(color.Background)
               .Append(";color:")
               .Append(color.Text)
               .Append(";}");
    }

    private static void AppendIndicatorRule(StringBuilder builder, string selector, (string Background, string Text) color)
    {
        builder.Append(selector)
               .Append("{background-color:")
               .Append(color.Background)
               .Append(";}");
    }

    private static (double h, double s, double l) RgbToHsl(byte r, byte g, byte b)
    {
        var rd = r / 255d;
        var gd = g / 255d;
        var bd = b / 255d;

        var max = Math.Max(rd, Math.Max(gd, bd));
        var min = Math.Min(rd, Math.Min(gd, bd));
        var delta = max - min;

        double h;
        if (delta == 0)
        {
            h = 0;
        }
        else if (max == rd)
        {
            h = 60 * (((gd - bd) / delta) % 6);
        }
        else if (max == gd)
        {
            h = 60 * (((bd - rd) / delta) + 2);
        }
        else
        {
            h = 60 * (((rd - gd) / delta) + 4);
        }

        if (h < 0)
        {
            h += 360;
        }

        var l = (max + min) / 2d;
        var s = delta == 0 ? 0 : delta / (1 - Math.Abs(2 * l - 1));

        return (h, s, l);
    }

    private static double ShiftHue(double baseHue, double offset)
    {
        var hue = (baseHue + offset) % 360d;
        return hue < 0 ? hue + 360d : hue;
    }

    private static (byte r, byte g, byte b) FromHsl(double h, double s, double l)
    {
        var c = (1 - Math.Abs(2 * l - 1)) * s;
        var x = c * (1 - Math.Abs((h / 60d % 2) - 1));
        var m = l - c / 2d;

        double rd;
        double gd;
        double bd;

        if (h < 60)
        {
            rd = c; gd = x; bd = 0;
        }
        else if (h < 120)
        {
            rd = x; gd = c; bd = 0;
        }
        else if (h < 180)
        {
            rd = 0; gd = c; bd = x;
        }
        else if (h < 240)
        {
            rd = 0; gd = x; bd = c;
        }
        else if (h < 300)
        {
            rd = x; gd = 0; bd = c;
        }
        else
        {
            rd = c; gd = 0; bd = x;
        }

        var r = (byte)Math.Round((rd + m) * 255);
        var g = (byte)Math.Round((gd + m) * 255);
        var b = (byte)Math.Round((bd + m) * 255);

        return (r, g, b);
    }

    private static string GetReadableText(byte r, byte g, byte b)
    {
        static double Linearize(byte channel)
        {
            var c = channel / 255d;
            return c <= 0.04045 ? c / 12.92 : Math.Pow((c + 0.055) / 1.055, 2.4);
        }

        var luminance = 0.2126 * Linearize(r) + 0.7152 * Linearize(g) + 0.0722 * Linearize(b);

        return luminance > 0.5 ? "rgba(17,24,39,1)" : "rgba(255,255,255,1)";
    }
}
