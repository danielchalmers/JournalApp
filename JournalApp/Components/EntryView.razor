@namespace JournalApp
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@inject IDialogService DialogService
@inject FocusService FocusService

<MudCard>
	<MudCardContent>
		@if (Full)
		{
			<MudDatePicker @bind-Date="@Model.Date" />
		}
		else
		{
			@Model.Date.ToString()
		}

		@if (@Model is Note note)
		{
			<MudTextField Lines="4" Placeholder="What's on your mind?" @bind-Value="note.Text" @onfocus="OnFocus" />
		}
	</MudCardContent>

	@if (Full)
	{
		<MudCardActions>
			<MudButton OnClick="Delete" StartIcon="@Icons.Material.Outlined.Delete">Delete</MudButton>
		</MudCardActions>
	}
</MudCard>

@code {
	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	[Parameter]
	public bool Full { get; set; }

	[Parameter]
	public JournalEntry Model { get; set; }

	protected override void OnInitialized()
	{
		base.OnInitialized();

		FocusService.FocusChanged += (_, entry) =>
		{
			var isFocusedOnCurrentEntry = entry == Model;
			Full = isFocusedOnCurrentEntry;
			StateHasChanged();
		};
	}

	async Task Delete()
	{
		if (await DialogService.ShowMessageBox("Delete entry", $"This entry from {Model.Date} will be deleted.", yesText: "Delete", noText: "Keep it") == true)
			return;

		Model.IsDeleted = true;
		StateHasChanged();
	}

	void OnFocus()
	{
		FocusService.ChangeFocus(Model);
	}
}