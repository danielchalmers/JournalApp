@namespace JournalApp
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@inject IDialogService DialogService
@inject FocusService FocusService
@inject ApplicationDbContext db

<MudCard>
	<MudCardContent>
		@Model.Date.ToString()

		@if (@Model is Note note)
		{
			<MudTextField Lines="4" Placeholder="What's on your mind?" @bind-Value="note.Text" @onfocus="OnFocus" />
		}
	</MudCardContent>

	@if (Full)
	{
		<MudCardActions>
			<MudButton OnClick="Delete" StartIcon="@Icons.Material.Outlined.Delete">Delete</MudButton>
		</MudCardActions>
	}
</MudCard>

@code {
	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	[Parameter]
	public bool Full { get; set; }

	[Parameter]
	public JournalEntry Model { get; set; }

	protected override void OnInitialized()
	{
		base.OnInitialized();

		FocusService.FocusChanged += async (_, entry) =>
		{
			// Save changes now that user has finished editing the last note.
			await db.SaveChangesAsync();

			// Make this full if it's the one being requested, otherwise make it small.
			Full = entry == Model;

			// Update the UI to reflect this change.
			StateHasChanged();
		};
	}

	async Task Delete()
	{
		if (await DialogService.ShowMessageBox("Delete entry", $"This entry from {Model.Date} will be deleted.", yesText: "Delete", noText: "Keep it") != true)
			return;

		Model.IsDeleted = true;
		await db.SaveChangesAsync();
	}

	void OnFocus()
	{
		FocusService.ChangeFocus(Model);
	}
}