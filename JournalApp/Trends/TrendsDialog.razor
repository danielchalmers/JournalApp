@namespace JournalApp.Trends
@inject AppDbContext db
@inject ILogger<TrendsDialog> logger
@inject IDialogService DialogService
@inject KeycodeService KeycodeService

<MudDialog DefaultFocus="DefaultFocus.None">
	<TitleContent>
		<div class="page-header">
			<MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="Submit" />

			<MudText Typo="Typo.h6">Trends</MudText>
		</div>

		<TrendsSwitcher @bind-SelectedDate="SelectedDate" />
	</TitleContent>

	<DialogContent>
		<div class="trends-container">
			@foreach (var group in FilteredCategories.GroupBy(x => x.Type))
			{
				@foreach (var category in group)
				{
					<div>
						<MudText Typo="Typo.h6">@category.Name</MudText>

							<div class="trend-view">
								@if (category.Type == DataType.Mood)
							{
								foreach (var (day, point) in _points[category])
								{
									<MudText Typo="Typo.caption">@(point?.Mood ?? day.ToString())</MudText>
								}
							}
							else
							{
								<MudText Typo="Typo.caption">TBA</MudText>
							}
						</div>
					</div>
				}
			}
		</div>
	</DialogContent>
</MudDialog>

@code {
	Dictionary<DataPointCategory, IReadOnlyDictionary<int, DataPoint>> _points;
	DateOnly _selectedDate;

	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	[Parameter]
	public DateOnly OpenToDate { get; set; }

	public IEnumerable<DataPointCategory> FilteredCategories => db.Categories.Where(x => x.Enabled && !x.IsDeleted && x.Group == null);

	public DateOnly SelectedDate
	{
		get => _selectedDate;
		set
		{
			_selectedDate = value;

			// Organize data points by category and day of month.
			var days = Enumerable.Range(1, DateTime.DaysInMonth(value.Year, value.Month));
			_points = new();
			foreach (var category in FilteredCategories)
				_points.Add(category, days.ToDictionary(d => d, d => category.DataPoints.SingleOrDefault(p => p.Day.Date.Year == value.Year && p.Day.Date.Month == value.Month && p.Day.Date.Day == d)));
		}
	}

	protected override void OnInitialized()
	{
		base.OnInitialized();

		KeycodeService.SubscribeOnceToBackButtonPressed(() => Submit());

		logger.LogInformation($"Opened to {OpenToDate}");
		SelectedDate = new(OpenToDate.Year, OpenToDate.Month, 1);
	}

	void Submit()
	{
		MudDialog.Close(DialogResult.Ok(true));
	}
}