@namespace JournalApp
@page "/trends/{OpenToDateString}"
@using CommunityToolkit.Maui.Storage;
@inherits JaPage
@implements IDisposable
@inject ILogger<TrendsPage> logger
@inject IDbContextFactory<AppDbContext> DbFactory

<header class="page-header">
    <div class="page-toolbar">
        <MudIconButton Icon="@Icons.Material.Rounded.ArrowBack" aria-label="Go home" OnClick="Close" />

        <MudText Typo="Typo.h6">Trends</MudText>
    </div>

    <TrendsSwitcher @bind-SelectedDates="SelectedDates" @bind-SelectedDates:after="LoadDates" OpenToDate="OpenToDate" />
</header>

<main class="page-body">
    <div id="trends-category-list">
        @foreach (var (category, points) in VisibleCategories)
        {
            @if (category.Group == "Notes" && Preferences.Get("hide_notes", false))
            {
                continue;
            }

            <section class="trends-category">
                <MudText Class="list-group-title">@(TrendCategoryView.GetHeaderText(category))</MudText>

                <ErrorBoundary>
                    <ChildContent>
                        <TrendCategoryView Category="category" Dates="SelectedDates" PointsByDay="points" />
                    </ChildContent>

                    <ErrorContent>
                        <MudText Color="Color.Error">💥 Failed to load.</MudText>
                    </ErrorContent>
                </ErrorBoundary>
            </section>
        }
    </div>
</main>

@code {
    const int CategoryLoadDelayMs = 50;

    [Parameter]
    public string OpenToDateString { get; set; }

    public DateOnly OpenToDate { get; set; }

    public IReadOnlyList<DateOnly> SelectedDates { get; set; }

    Dictionary<DataPointCategory, IReadOnlyDictionary<int, IReadOnlyCollection<DataPoint>>> AllPoints = new();
    List<KeyValuePair<DataPointCategory, IReadOnlyDictionary<int, IReadOnlyCollection<DataPoint>>>> VisibleCategories = new();

    protected override void OnInitialized()
    {
        logger.LogDebug("Initializing");
        base.OnInitialized();

        KeyEventService.Entered(() => Close());

        OpenToDate = DateOnly.ParseExact(OpenToDateString, "yyyyMMdd");
        logger.LogInformation("Opening trends to {OpenToDate}", OpenToDate);
    }

    async Task LoadDates()
    {
        logger.LogInformation("Loading trends for {StartDate}..{EndDate}", SelectedDates[0], SelectedDates[^1]);
        var sw = Stopwatch.StartNew();

        await using var db = await DbFactory.CreateDbContextAsync();

        // All the points we want to show.
        var query = db.Points
            .Where(p => !p.Deleted && !p.Category.Deleted && p.Category.Enabled && SelectedDates.Contains(p.Day.Date))
            .Include(p => p.Category)
            .Include(p => p.Day)
            .AsEnumerable()
            .OrderBy(p => p.Day.Date)
            .ThenBy(p => p.CreatedAt)
            .GroupBy(
                p => p.Category,
                p => p
            );

        // Group points by category then day number.
        AllPoints.Clear();
        foreach (var group in query)
        {
            var pointsByDayNumber = new Dictionary<int, IReadOnlyCollection<DataPoint>>();

            foreach (var date in SelectedDates)
            {
                pointsByDayNumber.Add(date.Day, group.Where(p => p.Day.Date == date).ToHashSet());
            }

            AllPoints.Add(group.Key, pointsByDayNumber);
        }

        sw.Stop();
        logger.LogInformation("Loaded trends data in {ElapsedMilliseconds}ms (categories: {CategoryCount})", sw.ElapsedMilliseconds, AllPoints.Count);

        // Progressive loading: render charts from top to bottom
        await LoadCategoriesProgressively();
    }

    private async Task LoadCategoriesProgressively()
    {
        VisibleCategories.Clear();
        
        var orderedCategories = AllPoints.OrderBy(x => x.Key.Group).ThenBy(x => x.Key.Index).ToList();
        
        if (orderedCategories.Count == 0)
        {
            return;
        }

        // Load first category immediately
        VisibleCategories.Add(orderedCategories[0]);
        StateHasChanged();

        // Load remaining categories progressively
        for (int i = 1; i < orderedCategories.Count; i++)
        {
            // Small delay to allow the previous chart to render
            await Task.Delay(CategoryLoadDelayMs);
            VisibleCategories.Add(orderedCategories[i]);
            StateHasChanged();
        }
    }

    void Close()
    {
        logger.LogInformation("Going to index");
        NavigationManager.NavigateTo("/", false, true);
    }

    protected override void Dispose(bool disposing)
    {
        logger.LogDebug("Disposing");
        base.Dispose(disposing);

        KeyEventService.Exited();
    }
}
