@namespace JournalApp
@inherits LayoutComponentBase
@implements IDisposable
@inject ILogger<MainLayout> logger
@inject KeyEventService KeyEventService
@inject NavigationManager NavigationManager
@inject PreferenceService PreferenceService
@inject SystemColorService SystemColorService
@inject IJSRuntime JSRuntime

<MudThemeProvider Theme="_theme" IsDarkMode="PreferenceService.IsDarkMode" DefaultScrollbar />

<MudPopoverProvider />

<MudDialogProvider MaxWidth="MaxWidth.Small"
                   FullWidth="true"
                   NoHeader="false"
                   CloseButton="false"
                   CloseOnEscapeKey="false"
                   Position="DialogPosition.Center" />

<MudSnackbarProvider />

<div class="page">
    @Body
</div>

@code {
    bool _hasInitiallyRendered;
    IJSObjectReference _themeModule;

    MudTheme _theme = CreateBaseTheme();

    protected override void OnInitialized()
    {
        logger.LogDebug("Initializing");
        base.OnInitialized();

        PreferenceService.ThemeChanged += OnThemeChanged;
        App.NewIntent += OnNewIntent;

        if (App.Window is not null) // Not available in tests.
        {
            App.Window.Destroying += (_, _) => Dispose();
        }

        // All pages have been reloaded so we should clear any leftover subscriptions.
        KeyEventService.ResetStack();

        // Start import.
        if (App.ActivatedFilePath != null)
        {
            logger.LogDebug($"Activated by file <{App.ActivatedFilePath}>");
            NavigationManager.NavigateTo($"/settings", false, true);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _hasInitiallyRendered = true;
            _ = ApplyDynamicThemeAsync();
        }
    }

    public void OnThemeChanged(object sender, bool isDarkMode)
    {
        if (_hasInitiallyRendered)
            _ = InvokeAsync(ApplyDynamicThemeAsync);
    }

    void OnNewIntent(object sender, EventArgs e)
    {
        logger.LogDebug("New intent");
        NavigationManager.NavigateTo($"/settings", true, true);
    }

    public void Dispose()
    {
        PreferenceService.ThemeChanged -= OnThemeChanged;
        App.NewIntent -= OnNewIntent;
        if (_themeModule != null)
            _ = _themeModule.DisposeAsync();
    }

    static MudTheme CreateBaseTheme()
    {
        return new MudTheme
        {
            PaletteLight = new PaletteLight
            {
                Primary = "#5B5B5B",
                PrimaryContrastText = "#FFFFFF",
                Secondary = "#6B6B6B",
                SecondaryContrastText = "#FFFFFF",
                TextPrimary = "#1F1F1F",
                TextSecondary = "#3B3B3B",
                Error = "#B3261E",
                Background = "#FFFFFF",
                Surface = "#F5F5F5",
                HoverOpacity = 0.1,
            },
            PaletteDark = new PaletteDark
            {
                Primary = "#C7C7C7",
                PrimaryContrastText = "#1F1F1F",
                Secondary = "#B0B0B0",
                SecondaryContrastText = "#1F1F1F",
                TextPrimary = "#F1F1F1",
                TextSecondary = "#CFCFCF",
                Error = "#F2B8B5",
                Background = "#0F0F0F",
                Surface = "#1A1A1A",
                HoverOpacity = 0.1,
            },
            LayoutProperties = new LayoutProperties
            {
                DefaultBorderRadius = "4px",
            },
            Typography = new Typography
            {
                Button = new ButtonTypography
                {
                    TextTransform = "none",
                },
                Caption = new CaptionTypography
                {
                    LineHeight = "1",
                },
            },
        };
    }

    async Task ApplyDynamicThemeAsync()
    {
        try
        {
            _themeModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./theme/material-theme.js");
            var sourceColor = SystemColorService.GetSourceColorHex();

            var lightTokens = await _themeModule.InvokeAsync<MaterialThemeTokens>("getThemeTokens", sourceColor, false);
            var darkTokens = await _themeModule.InvokeAsync<MaterialThemeTokens>("getThemeTokens", sourceColor, true);

            ApplyTokens(_theme.PaletteLight, lightTokens);
            ApplyTokens(_theme.PaletteDark, darkTokens);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to apply dynamic theme. Using fallback palette.");
        }
    }

    static void ApplyTokens(PaletteLight palette, MaterialThemeTokens tokens)
    {
        palette.Primary = tokens.Primary;
        palette.PrimaryContrastText = tokens.OnPrimary;
        palette.Secondary = tokens.Secondary;
        palette.SecondaryContrastText = tokens.OnSecondary;
        palette.TextPrimary = tokens.OnBackground;
        palette.TextSecondary = tokens.OnSurfaceVariant;
        palette.Error = tokens.Error;
        palette.Background = tokens.Background;
        palette.Surface = tokens.Surface;
        palette.HoverOpacity = 0.1;
    }

    static void ApplyTokens(PaletteDark palette, MaterialThemeTokens tokens)
    {
        palette.Primary = tokens.Primary;
        palette.PrimaryContrastText = tokens.OnPrimary;
        palette.Secondary = tokens.Secondary;
        palette.SecondaryContrastText = tokens.OnSecondary;
        palette.TextPrimary = tokens.OnBackground;
        palette.TextSecondary = tokens.OnSurfaceVariant;
        palette.Error = tokens.Error;
        palette.Background = tokens.Background;
        palette.Surface = tokens.Surface;
        palette.HoverOpacity = 0.1;
    }
}
