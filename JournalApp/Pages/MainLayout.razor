@namespace JournalApp
@inherits LayoutComponentBase
@implements IDisposable
@inject ILogger<MainLayout> logger
@inject KeyEventService KeyEventService
@inject NavigationManager NavigationManager
@inject PreferenceService PreferenceService
@inject ThemeService ThemeService

<MudThemeProvider Theme="_theme" IsDarkMode="PreferenceService.IsDarkMode" DefaultScrollbar />

<MudPopoverProvider />

<MudDialogProvider MaxWidth="MaxWidth.Small"
                   FullWidth="true"
                   NoHeader="false"
                   CloseButton="false"
                   CloseOnEscapeKey="false"
                   Position="DialogPosition.Center" />

<MudSnackbarProvider />

<div class="page">
    @Body
</div>

@code {
    bool _hasInitiallyRendered;
    MudTheme _theme;

    protected override void OnInitialized()
    {
        logger.LogDebug("Initializing");
        base.OnInitialized();

        // Initialize theme from ThemeService
        _theme = ThemeService.CreateMudTheme();

        PreferenceService.ThemeChanged += OnThemeChanged;
        ThemeService.PaletteChanged += OnPaletteChanged;
        App.NewIntent += OnNewIntent;

        if (App.Window is not null) // Not available in tests.
        {
            App.Window.Destroying += (_, _) => Dispose();
        }

        // All pages have been reloaded so we should clear any leftover subscriptions.
        KeyEventService.ResetStack();

        // Start import.
        if (App.ActivatedFilePath != null)
        {
            logger.LogDebug($"Activated by file <{App.ActivatedFilePath}>");
            NavigationManager.NavigateTo($"/settings", false, true);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _hasInitiallyRendered = true;
        }
    }

    public void OnThemeChanged(object sender, bool isDarkMode)
    {
        if (_hasInitiallyRendered)
            StateHasChanged();
    }

    void OnPaletteChanged(object sender, EventArgs e)
    {
        logger.LogDebug("Palette changed, regenerating theme");
        _theme = ThemeService.CreateMudTheme();
        if (_hasInitiallyRendered)
            StateHasChanged();
    }

    void OnNewIntent(object sender, EventArgs e)
    {
        logger.LogDebug("New intent");
        NavigationManager.NavigateTo($"/settings", true, true);
    }

    public void Dispose()
    {
        PreferenceService.ThemeChanged -= OnThemeChanged;
        ThemeService.PaletteChanged -= OnPaletteChanged;
        App.NewIntent -= OnNewIntent;
    }
}
